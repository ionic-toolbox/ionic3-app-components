
import { Component, Input, ElementRef }	from '@angular/core';
import { Events }						from 'ionic-angular';

@Component({
	selector: 'smt-img',
	template: '<img />'
})
export class SmartImage {
	_imgURL = null;
	_delayLoad: boolean;

	_loopChecker: boolean;

	_fakeImg: HTMLImageElement;
	_inViewport: boolean;

	@Input()
	set src(val: string) {
		this._imgURL = val;
	}

	@Input()
	set lazy(val: string) {
		this._delayLoad = true;
	}

	constructor(public elm: ElementRef, public events: Events) {
		
	}

	ngOnInit(): void {

		let image = this.elm.nativeElement.children[0];
		let loadingURL = this._getLoadingImg();

		image.src = loadingURL;

		this._fakeImg = new Image();
		this._fakeImg.addEventListener('error', () => {
			image.src = this._getMissingImg();
		});
		this._fakeImg.addEventListener('load', () => {
			image.src = this._imgURL;
		});

		setTimeout(() => {
			this._inViewport = this._isElementInViewport(this.elm.nativeElement);
			if (this._inViewport) this._delayLoad = false;

			if (this._delayLoad) {
				this._startLazyLoadCheck();
				return;
			}
			this._fakeImg.src = this._imgURL;

		}, 100);

	}

	scrollNotify() {
		if (this._loopChecker) return;
		if (!this._delayLoad) return;

		let inViewport = this._isElementInViewport(this.elm.nativeElement);
		if (inViewport) {

			this._fakeImg.src = this._imgURL;

			this._stopLazyLoadCheck();
		}
	}

	ngOnDestroy(): void {
	}

	_startLazyLoadCheck() {
		setTimeout(() => this.events.publish('smartimage', this), 100);
	}

	_stopLazyLoadCheck() {
		this._loopChecker = true;
	}

	_isElementInViewport(el) {
		var rect = el.getBoundingClientRect();
		var threshold = 0;
		return (
			rect.top >= (0 - threshold) &&
			rect.left >= (0 - threshold) &&
			rect.top <= (window.innerHeight + threshold) &&
			rect.left <= (window.innerWidth + threshold)
		);
	}

	_getLoadingImg() {
		let base64prefix = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAwIDEwMDAiPjxkZWZzPjxyYWRpYWxHcmFkaWVudCBpZD0icmFkaWFsLWdyYWRpZW50IiBjeD0iNTAwIiBjeT0iNTAwIiByPSI1MDAiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiNkZmRmZGYiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM5OTkiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48cmVjdCBmaWxsPSJ1cmwoI3JhZGlhbC1ncmFkaWVudCkiIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjEwMDAiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJNNjAxIDQxNGwwIDBWNTg2bDAgMEgzOTlsMCAwVjQxNGwwIDBINjAxWm0wLTE0SDM5OUExNCAxNCAwIDAgMCAzODUgNDE0djE3M2ExNCAxNCAwIDAgMCAxNCAxNEg2MDFBMTQgMTQgMCAwIDAgNjE1IDU4NlY0MTRhMTQgMTQgMCAwIDAtMTQtMTRoMFpNNTc';
		let loadingDefault = `${base64prefix}1IDUwMmE3NyA3NyAwIDAgMC0yNC01NCA3NiA3NiAwIDAgMC0yNS0xNiA3NSA3NSAwIDAgMC01NyAxQTc0IDc0IDAgMCAwIDQzMCA0NzQgNzMgNzMgMCAwIDAgNDMxIDUzMGE3MiA3MiAwIDAgMCAzOSAzOCA3MCA3MCAwIDAgMCA1NC0xIDY5IDY5IDAgMCAwIDM3LTM4IDY4IDY4IDAgMCAwIDQtMTZsMSAwYTEwIDEwIDAgMCAwIDEwLTEwYzAgMCAwLTEgMC0xaDBabS0xNSAyNmE2NyA2NyAwIDAgMS0zNyAzNSA2NiA2NiAwIDAgMS01MC0xIDY0IDY0IDAgMCAxLTM0LTM1QTYzIDYzIDAgMCAxIDQ0MCA0NzkgNjIgNjIgMCAwIDEgNDU0IDQ1OSA2MiA2MiAwIDAgMSA0NzQgNDQ2YTYxIDYxIDAgMCAxIDIzLTQgNjAgNjAgMCAwIDEgNDIgMTlBNTkgNTkgMCAwIDEgNTUyIDQ4MGE1OCA1OCAwIDAgMSA0IDIyaDBjMCAwIDAgMSAwIDFhMTAgMTAgMCAwIDAgOSAxMCA2NyA2NyAwIDAgMS01IDE1aDBaIi8+PC9zdmc+`;
		return loadingDefault;
	}

	_getMissingImg() {
		let base64prefix = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAwIDEwMDAiPjxkZWZzPjxyYWRpYWxHcmFkaWVudCBpZD0icmFkaWFsLWdyYWRpZW50IiBjeD0iNTAwIiBjeT0iNTAwIiByPSI1MDAiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiNkZmRmZGYiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM5OTkiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48cmVjdCBmaWxsPSJ1cmwoI3JhZGlhbC1ncmFkaWVudCkiIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjEwMDAiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJNNjAxIDQxNGwwIDBWNTg2bDAgMEgzOTlsMCAwVjQxNGwwIDBINjAxWm0wLTE0SDM5OUExNCAxNCAwIDAgMCAzODUgNDE0djE3M2ExNCAxNCAwIDAgMCAxNCAxNEg2MDFBMTQgMTQgMCAwIDAgNjE1IDU4NlY0MTRhMTQgMTQgMCAwIDAtMTQtMTRoMFpNNTc';
		let missingDefault = `${base64prefix}yIDQ1MGEyMiAyMiAwIDEgMS0yMi0yMkEyMiAyMiAwIDAgMSA1NzIgNDUwWk01ODYgNTcySDQxNFY1NDNsNTAtODYgNTggNzJoMTRsNTAtNDN2ODZaIi8+PC9zdmc+`;

		return missingDefault;
	}



}
